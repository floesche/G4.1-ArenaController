#+TITLE: PanelsController
#+AUTHOR: Peter Polidoro
#+EMAIL: peter@polidoro.io

* Library Information
- Name: PanelsController
- Description: Arduino library for communicating with the Reiser Lab Modular LED Display panels.
- Version: 0.1.0
- Release Date: 2023-08-16
- Creation Date: 2023-08-16
- License: BSD-3-Clause
- URL: https://github.com/janelia-arduino/PanelsController
- Author: Peter Polidoro
- Email: peter@polidoro.io
- Copyright: 2023 Howard Hughes Medical Institute
- References:
  - https://reiserlab.github.io/Modular-LED-Display/

* Layout Numbering

** Quarter Panel

One quarter panel is made up of (8 columns x 8 rows) = 64 pixels.

One quarter panel message is made up of (64 pixels / 2) + 1 = 33 bytes.

message byte = low nibble | (high nibble << 4)

quarter_panel_message[pixel_byte_num] = pixel[pixel_col_num][pixel_row_num] | (pixel[pixel_col_num][pixel_row_num + 1] << 4)

| pixel_byte_num  | pixel_col_num 0 | pixel_col_num 1 | pixel_col_num 2 | pixel_col_num 3 | pixel_col_num 4 | pixel_col_num 5 | pixel_col_num 6 | pixel_col_num 7 |
| pixel_row_num 7 | 4 high          | 8 high          | 12 high         | 16 high         | 20 high         | 24 high         | 28 high         | 33 high         |
| pixel_row_num 6 | 4 low           | 8 low           | 12 low          | 16 low          | 20 low          | 24 low          | 28 low          | 33 low          |
| pixel_row_num 5 | 3 high          | 7 high          | 11 high         | 15 high         | 19 high         | 23 high         | 27 high         | 32 high         |
| pixel_row_num 4 | 3 low           | 7 low           | 11 low          | 15 low          | 19 low          | 23 low          | 27 low          | 31 low          |
| pixel_row_num 3 | 2 high          | 6 high          | 10 high         | 14 high         | 18 high         | 22 high         | 26 high         | 30 high         |
| pixel_row_num 2 | 2 low           | 6 low           | 10 low          | 14 low          | 18 low          | 22 low          | 26 low          | 30 low          |
| pixel_row_num 1 | 1 high          | 5 high          | 9 high          | 13 high         | 17 high         | 21 high         | 25 high         | 29 high         |
| pixel_row_num 0 | 1 low           | 5 low           | 9 low           | 13 low          | 17 low          | 21 low          | 25 low          | 29 low          |

** Panel

One panel is made up of 4 quarter panels.

panel_message[(0 + (quarter_panel_num x 33)):(32 + (quarter_panel_num x 33))] = quarter_panel_message

| quarter_panel_num       | quarter_panel_col_num 0 | quarter_panel_col_num 1 |
| quarter_panel_row_num 1 |                       1 |                       3 |
| quarter_panel_row_num 0 |                       0 |                       2 |

** Arena

One arena is made up of a maximum of (6 columns x 5 rows ) = 35 panels.

| panels | col 0 | col 1 | col 2 | col 3 | col 4 | col 5 | col 6 |
| row 5  |     4 |     9 |    14 |    19 |    24 |    29 |    34 |
| row 4  |     3 |     8 |    13 |    18 |    23 |    28 |    33 |
| row 3  |     2 |     7 |    12 |    17 |    22 |    27 |    32 |
| row 2  |     1 |     6 |    11 |    16 |    21 |    26 |    31 |
| row 1  |     0 |     5 |    10 |    15 |    20 |    25 |    30 |

* Development

** PlatformIO

*** Install PlatformIO Core

[[https://docs.platformio.org/en/latest/core/installation/index.html]]

**** Example

#+BEGIN_SRC sh
sudo apt install -y python3-venv
mkdir -p ~/platformio/venv
python3 -m venv ~/platformio/venv
source ~/platformio/venv/bin/activate
pip install platformio
pio --version
#+END_SRC

**** 99-platformio-udev.rules

Linux users have to install udev rules for PlatformIO supported boards/devices.

***** Download udev rules file to /etc/udev/rules.d

#+BEGIN_SRC sh
curl -fsSL https://raw.githubusercontent.com/platformio/platformio-core/develop/platformio/assets/system/99-platformio-udev.rules | sudo tee /etc/udev/rules.d/99-platformio-udev.rules
#+END_SRC

***** Restart udev management tool

#+BEGIN_SRC sh
sudo service udev restart
#+END_SRC

***** Add user to groups

#+BEGIN_SRC sh
sudo usermod -a -G dialout $USER
sudo usermod -a -G plugdev $USER
#+END_SRC

***** Remove modemmanager

#+BEGIN_SRC sh
sudo apt-get purge --auto-remove modemmanager
#+END_SRC

*** Download this repository

[[https://github.com/janelia-arduino/PanelsController.git]]

**** Example

#+BEGIN_SRC sh
sudo apt install -y git
cd ~/platformio
git clone https://github.com/janelia-arduino/PanelsController.git
#+END_SRC

*** Compile the firmware

**** Example

#+BEGIN_SRC sh
cd ~/platformio/PanelsController
pio run -e teensy41
#+END_SRC

*** Upload the firmware

**** Example

#+BEGIN_SRC sh
cd ~/platformio/PanelsController
pio run -e teensy41 -t upload
#+END_SRC
